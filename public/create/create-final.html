<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>캐릭터 결말 생성중...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="/stylesheet/base/common.css">
    <link rel="stylesheet" href="/stylesheet/base/index.css">

    <style>
        body {
            margin: 0;
            color: white;
            font-family: sans-serif;
        }

        #loadingBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: .9;
        }

        .spinner {
            border: 6px solid rgba(255,255,255,0.2);
            border-top: 6px solid #fff;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin: 0 auto 20px auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="bg-root">
        <div class="bg-frame"></div>

        <div id="loadingBox">
            <div class="spinner"></div>
            <div>캐릭터의 이야기를 마무리하고 있습니다.</div>
            <div>잠시만 기다려 주세요.</div>

            <!-- 🔥 홈 이동 버튼 추가 -->
            <button id="btnGoHome"
                    style="
                margin-top:20px;
                padding:8px 16px;
                background:#ffffff22;
                border:1px solid #fff;
                color:#fff;
                border-radius:6px;
                cursor:pointer;
            ">
                홈으로 이동
            </button>
        </div>

    </div>

    <script type="module">
        import { apiFetch } from "/base/api.js";

        async function gen() {
            try {
                const res = await apiFetch("/create/final", {
                    method: "POST"
                });

                const j = await res.json();

                // 🔒 이미 호출 중이거나 처리 중인 경우
                if (j.status === "waiting") {
                    document.getElementById("loadingBox").innerHTML =
                        `<div>결말을 정리하고 있습니다...</div>
                             <div>곧 완료됩니다.</div>`;
                    return;
                }

                // ✅ 이미 완료된 경우
                if (j.status === "done") {
                  
                   

                    document.getElementById("loadingBox").innerHTML =
                        `<div>캐릭터 생성이 완료되었습니다.</div>
                             <div>잠시 후 이동합니다.</div>`;
                    setTimeout(() => {
                        sessionStorage.setItem("viewCharId", j.id);
                        sessionStorage.setItem("homeCalled", "false");

                        // SPA 진입
                        location.href = `/character/${j.id}`;

                    }, 1200);

                    return;
                }

                // ❌ 실패 (서버 정책상 재시도 불가)
                if (!j.ok) {
             

                    document.getElementById("loadingBox").innerHTML =
                        `<div>캐릭터 생성이 종료되었습니다.</div>
                             <div>다시 생성할 수 있습니다.</div>
                             <div style="margin-top:12px; opacity:.7;">잠시 후 이동합니다.</div>`;
                    setTimeout(() => {
                        sessionStorage.setItem("homeCalled", "false");
                        location.href = "/";

                    }, 2000);
                    return;
                }

                // ✅ 정상 성공 응답
                document.getElementById("loadingBox").innerHTML =
                    `<div>캐릭터 생성이 완료되었습니다.</div>
                         <div>잠시 후 이동합니다.</div>`;
                setTimeout(() => {
                    sessionStorage.setItem("viewCharId", j.id);
                    sessionStorage.setItem("homeCalled", "false");

                    // SPA 진입
                    location.href = `/character/${j.id}`;


                }, 1200);

            } catch (err) {
                // 네트워크 / 예외 오류
                document.getElementById("loadingBox").innerHTML =
                    `<div>처리 중 문제가 발생했습니다.</div>
                         <div>캐릭터 생성은 종료되었습니다.</div>
                         <div style="margin-top:12px; opacity:.7;">잠시 후 이동합니다.</div>`;
                setTimeout(() => {
                    sessionStorage.setItem("homeCalled", "false");
                    location.href = "/";

                }, 2500);
            }
        }
       
        history.replaceState(null, "", "/create");
        gen();

        // 🔥 홈 이동 버튼 이벤트
        const btnGoHome = document.getElementById("btnGoHome");
        btnGoHome?.addEventListener("click", () => {

            // 생성 플래그 종료
           
            sessionStorage.setItem("homeCalled", "false");

            // 홈으로 이동
            location.href = "/";

        });

    </script>
</body>
</html>
